databaseChangeLog:
  - changeSet:
      id: 004_create_side_enum_v2
      author: lucian
      changes:
        - sql:
            splitStatements: false
            sql: |
              DO $$
              BEGIN
                IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'side') THEN
                  CREATE TYPE side AS ENUM ('FRONT', 'BACK', 'ANY');
                END IF;
              END
              $$;

  - changeSet:
      id: 004_create_subject_table_v2
      author: lucian
      changes:
        - createTable:
            ifNotExists: true
            tableName: subject
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: name
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
                    unique: true
                    defaultValue: "New Subject"
              - column:
                  name: front_label
                  type: VARCHAR(255)
                  constraints:
                    nullable: true
              - column:
                  name: back_label
                  type: VARCHAR(255)
                  constraints:
                    nullable: true
              - column:
                  name: default_side
                  type: side
                  constraints:
                    nullable: true
                    defaultValue: "FRONT"
              - column:
                  name: display_deck_names
                  type: BOOLEAN
                  constraints:
                    nullable: true
                    defaultValue: "false"

  - changeSet:
      id: 004_insert_initial_subject_v2
      author: lucian
      changes:
        - insert:
            tableName: subject
            columns:
              - column:
                  name: name
                  value: "Custom Subject"
              - column:
                  name: front_label
                  value: "Custom Front"
              - column:
                  name: back_label
                  value: "Custom Back"
              - column:
                  name: default_side
                  value: "FRONT"
              - column:
                  name: display_deck_names
                  valueBoolean: false
  - changeSet:
      id: 004_add_subject_to_card_and_deck
      author: lucian
      changes:
        - addColumn:
            ifNotExists: true
            tableName: card
            columns:
              - column:
                  name: subject_id
                  type: BIGINT

        - addColumn:
            tableName: deck
            ifNotExists: true
            columns:
              - column:
                  name: subject_id
                  type: BIGINT

        - addForeignKeyConstraint:
            baseTableName: card
            baseColumnNames: subject_id
            referencedTableName: subject
            referencedColumnNames: id
            constraintName: fk_card_subject

        - addForeignKeyConstraint:
            baseTableName: deck
            baseColumnNames: subject_id
            referencedTableName: subject
            referencedColumnNames: id
            constraintName: fk_deck_subject

  - changeSet:
      id: 004_backfill_subject_for_existing_cards_and_decks
      author: lucian
      changes:
        - sql:
            sql: |
              UPDATE card SET subject_id = 1 WHERE subject_id IS NULL;
              UPDATE deck SET subject_id = 1 WHERE subject_id IS NULL;
              
  - changeSet:
      id: 004_make_subject_id_non_nullable
      author: lucian
      changes:
        - addNotNullConstraint:
            tableName: card
            columnName: subject_id
            columnDataType: BIGINT
        - addNotNullConstraint:
            tableName: deck
            columnName: subject_id
            columnDataType: BIGINT
