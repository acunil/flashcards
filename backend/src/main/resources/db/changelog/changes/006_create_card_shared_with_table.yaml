databaseChangeLog:
  # 1) Drop old global UNIQUE(front, back) on card (PostgreSQL-safe)
  - changeSet:
      id: 006_drop_unique_front_back
      author: lucian
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              DO $$
              DECLARE
                cons_name text;
              BEGIN
                -- Find the UNIQUE constraint exactly on (front, back)
                SELECT conname
                INTO cons_name
                FROM pg_constraint c
                JOIN pg_class t
                  ON t.oid = c.conrelid
                WHERE t.relname = 'card'
                  AND c.contype = 'u'
                  AND (
                    SELECT array_agg(a.attname::text ORDER BY a.attnum)
                    FROM unnest(c.conkey) k(attnum)
                    JOIN pg_attribute a
                      ON a.attrelid = c.conrelid
                     AND a.attnum = k.attnum
                  ) = ARRAY['front','back'];

                -- Drop the constraint (which will drop its index too)
                IF cons_name IS NOT NULL THEN
                  EXECUTE format('ALTER TABLE card DROP CONSTRAINT IF EXISTS %I', cons_name);
                END IF;
              END $$;

  # 2) Add per-owner uniqueness (user_id, front, back)
  - changeSet:
      id: 006_unique_card_user_front_back
      author: lucian
      changes:
        - createIndex:
            tableName: card
            indexName: ux_card_user_front_back
            unique: true
            columns:
              - column:
                  name: user_id
              - column:
                  name: front
              - column:
                  name: back

  # 3) Add fork provenance: card.forked_from_card_id + FK -> card(id)
  - changeSet:
      id: 006_add_forked_from_column
      author: lucian
      changes:
        - addColumn:
            tableName: card
            columns:
              - column:
                  name: forked_from_card_id
                  type: BIGINT
                  constraints:
                    nullable: true
        - addForeignKeyConstraint:
            baseTableName: card
            baseColumnNames: forked_from_card_id
            referencedTableName: card
            referencedColumnNames: id
            onDelete: SET NULL
            constraintName: fk_card_forked_from_card

  # 4) Create share-link join table card_shared_with (card_id, user_id)
  - changeSet:
      id: 006_create_card_shared_with
      author: lucian
      changes:
        - createTable:
            tableName: card_shared_with
            columns:
              - column:
                  name: card_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: user_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: shared_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
        - addPrimaryKey:
            tableName: card_shared_with
            columnNames: card_id, user_id
            constraintName: pk_card_shared_with
        - addForeignKeyConstraint:
            baseTableName: card_shared_with
            baseColumnNames: card_id
            referencedTableName: card
            referencedColumnNames: id
            onDelete: CASCADE
            constraintName: fk_card_shared_with_card
        - addForeignKeyConstraint:
            baseTableName: card_shared_with
            baseColumnNames: user_id
            referencedTableName: app_user
            referencedColumnNames: id
            onDelete: CASCADE
            constraintName: fk_card_shared_with_user

  # 5) Helpful indexes
  - changeSet:
      id: 006_index_card_forked_from_user
      author: lucian
      changes:
        - createIndex:
            tableName: card
            indexName: ix_card_forked_from_user
            columns:
              - column:
                  name: forked_from_card_id
              - column:
                  name: user_id

  - changeSet:
      id: 006_index_card_shared_with_user
      author: lucian
      changes:
        - createIndex:
            tableName: card_shared_with
            indexName: ix_card_shared_with_user
            columns:
              - column:
                  name: user_id

  # 6) Ensure one CardHistory per (user, card)
  - changeSet:
      id: 006_unique_card_history_user_card
      author: lucian
      changes:
        - createIndex:
            tableName: card_history
            indexName: ux_card_history_user_card
            unique: true
            columns:
              - column:
                  name: user_id
              - column:
                  name: card_id
